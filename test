	if @calc_by in ('all', 'ent') and @calc_period in ('all', 'day')
	 
	 begin
			
			insert into @kpi_fact_values
		SELECT @shift_date as [date] , k.kpi_name, e.ent_id,
		kpi_value_fact = case k.kpi_name
						when N'KIO'		then round(T_rab_fact / nullif(T_klnd_fond, 0), 5) end,  null, 'day' as interval 
						FROM [grkb_util_ents] e
		inner join grkb_kpi k on k.kpi_name = N'KIO' 
		LEFT join
		(
			SELECT util_log.ent_id,
				T_klnd_fond = @T_klnd_fond,
				T_rab_fact			= sum(case when state_desc = N'В РАБОТЕ' then duration_within_interval else 0 end) / @seconds_in_hour

			FROM (
					select util_log.*
					from dbo.grkb_fn_GetUtilLog(@start_time, dbo.grkb_fn_min_date(@end_time, @last_submitted_end_time)) util_log
					WHERE util_log.reas_pending = 0 and exists (
						select 1
						from [grkb_util_shift_submit] sh_s
						where util_log.event_time_local < sh_s.shift_end and (util_log.event_end_time_local is null or util_log.event_end_time_local >= sh_s.shift_start)
					)
					and @start_time < @last_submitted_end_time
				) util_log
			GROUP BY util_log.ent_id
		) util_log on e.ent_id = util_log.ent_id
		WHERE e.ent_id IN (7,39)
		
	end
